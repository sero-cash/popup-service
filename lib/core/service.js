"use strict";var __awaiter=this&&this.__awaiter||function(e,o,u,i){return new(u=u||Promise)(function(n,t){function s(e){try{r(i.next(e))}catch(e){t(e)}}function a(e){try{r(i.throw(e))}catch(e){t(e)}}function r(e){var t;e.done?n(e.value):((t=e.value)instanceof u?t:new u(function(e){e(t)})).then(s,a)}r((i=i.apply(e,o||[])).next())})},__generator=this&&this.__generator||function(n,s){var a,r,o,e,u={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return e={next:t(0),throw:t(1),return:t(2)},"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(a)throw new TypeError("Generator is already executing.");for(;u;)try{if(a=1,r&&(o=2&t[0]?r.return:t[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,t[1])).done)return o;switch(r=0,o&&(t=[2&t[0],o.value]),t[0]){case 0:case 1:o=t;break;case 4:return u.label++,{value:t[1],done:!1};case 5:u.label++,r=t[1],t=[0];continue;case 7:t=u.ops.pop(),u.trys.pop();continue;default:if(!(o=0<(o=u.trys).length&&o[o.length-1])&&(6===t[0]||2===t[0])){u=0;continue}if(3===t[0]&&(!o||t[1]>o[0]&&t[1]<o[3])){u.label=t[1];break}if(6===t[0]&&u.label<o[1]){u.label=o[1],o=t;break}if(o&&u.label<o[2]){u.label=o[2],u.ops.push(t);break}o[2]&&u.ops.pop(),u.trys.pop();continue}t=s.call(n,u)}catch(e){t=[6,e],r=0}finally{a=o=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}};Object.defineProperty(exports,"__esModule",{value:!0});var PopDB_1=require("../db/PopDB"),tables_1=require("./tables"),utils_1=require("jsuperzk/dist/utils/utils"),axios_1=require("axios"),bignumber_js_1=require("bignumber.js"),jsuperzk=require("jsuperzk/dist/index"),superzk=require("jsuperzk/dist/protocol/account"),tx_1=require("jsuperzk/dist/tx/tx"),db=new Map,assets=new Map,isSyncing=new Map,pendingAndConirmMap=new Map,latestSyncTime=(new Date).getTime(),latestBlock=0,syncIntervalId=null,syncTime=1e4,rpc=null,rpcId=0,operations={init:init,healthyCheck:healthyCheck,initAccount:initAccount,clearData:clearData,findUtxos:findUtxos,balanceOf:balancesOf,ticketsOf:ticketsOf,getTxList:getTxList,getTxDetail:getTxDetail,getPKrIndex:getPKrIndex,commitTx:commitTx,getSeroPrice:getSeroPrice,getPendingAndConfirming:getPendingAndConfirming};function getSeroPrice(n){var e=n.data;axios_1.default.get("https://data.gateio.co/api2/1/ticker/"+e).then(function(e){if(e&&e.data){var t=e.data;n.data=t,_postMessage(n)}}).catch(function(e){})}function commitTx(t){var e=t.data;try{_commitTx(e).then(function(e){console.log("_commitTx hash:",e),t.data=e,_postMessage(t)}).catch(function(e){console.error("_commitTx err:",e),t.error=e,_postMessage(t)})}catch(e){t.error=e.message,_postMessage(t)}}function calAssets(h){return __awaiter(this,void 0,void 0,function(){var t,n,s,a,r,o,u,i,l,c,d,f,_,b,g;return __generator(this,function(e){switch(e.label){case 0:return[4,h.selectAll(tables_1.tables.utxo.name)];case 1:if(!((t=e.sent())&&0<t.length))return[3,11];for(n=new Map,s=0,a=t;s<a.length;s++)r=a[s],(g=r.Asset)&&g.Tkn&&(_=utils_1.hexToCy(g.Tkn.Currency),b=new bignumber_js_1.default(g.Tkn.Value),n.has(_)?(o=(o=n.get(_)).plus(b),n.set(_,o)):n.set(_,b));return[4,h.selectAll(tables_1.tables.assets.name)];case 2:u=e.sent(),i=0,l=u,e.label=3;case 3:return i<l.length?(c=l[i],n.has(c.Currency)?((g=c).Amount=n.get(c.Currency).toString(10),[4,h.update(tables_1.tables.assets.name,g)]):[3,5]):[3,8];case 4:return e.sent(),n.delete(c.Currency),[3,7];case 5:return c.Amount="0",[4,h.update(tables_1.tables.assets.name,c)];case 6:e.sent(),e.label=7;case 7:return i++,[3,3];case 8:d=n.entries(),f=d.next(),e.label=9;case 9:return f.done?[3,11]:(_=f.value[0],b=f.value[1],g={Currency:_,Amount:b.toString(10)},[4,h.insert(tables_1.tables.assets.name,g)]);case 10:return e.sent(),f=d.next(),[3,9];case 11:return[2]}})})}function _genPrePramas(v,k){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(e){return[2,new Promise(function(e,t){var n=v.From,s=v.To,a=v.Value,r=v.Cy,o=v.Data,u=v.Gas,i=v.GasPrice,l=v.FeeCy,c=v.BuyShare,d=v.FeeValue;r=r||"SERO",l=l||"SERO",u=u||"0x"+new bignumber_js_1.default("4700000").toString(16),i=i||"0x"+new bignumber_js_1.default("1000000000").toString(16);var f={Currency:utils_1.default.cyToHex(r),Value:utils_1.default.toBN(a).toString(10)},_={Currency:utils_1.default.cyToHex(l),Value:new bignumber_js_1.default(i,16).multipliedBy(new bignumber_js_1.default(u,16)).toString(10)};d&&(_.Value=new bignumber_js_1.default(d).toString(10));var b=[{Addr:s,Asset:{Tkn:f}}],g=[];if(v.Tkts&&0<v.Tkts.size)for(var h=(p=v.Tkts.entries()).next();!h.done;){var m={Tkt:y={Category:utils_1.default.cyToHex(h.value[0]),Value:h.value[1]}};g.push({Addr:s,Asset:m}),h=p.next()}var T=b.concat(g),x={From:n,RefundTo:k.PKr,Fee:_,GasPrice:utils_1.default.toBN(i).toString(10),Cmds:null,Receptions:T};if(o&&(x.Receptions=[],x.RefundTo=k.MainPKr,x.Cmds={Contract:{Data:o,Asset:{Tkn:{Currency:utils_1.default.cyToHex(r),Value:utils_1.default.toBN(a).toString()}}}},s&&(x.Cmds.Contract.To=utils_1.default.bs58ToHex(s)+"0000000000000000000000000000000000000000000000000000000000000000"),v.Tkts&&0<v.Tkts.size))if(1<v.Tkts.size)t("Not support more tickets to contract!");else{var p;for(h=(p=v.Tkts.entries()).next();!h.done;){var y={Category:utils_1.default.cyToHex(h.value[0]),Value:h.value[1]};x.Cmds.Contract.Asset.Tkt=y,h=p.next()}}c&&(x.Receptions=[],x.RefundTo=k.MainPKr,x.Cmds={BuyShare:{Pool:c.Pool,Value:new bignumber_js_1.default(c.Value).toString(10),Vote:utils_1.default.bs58ToHex(c.Vote)}}),e(x)})]})})}function _storePending(r,o,u,i){return __awaiter(this,void 0,void 0,function(){var t,n,s,a;return __generator(this,function(e){switch(e.label){case 0:return t={TK:r,TxHash:o.Hash,Num_TxHash:"99999999999_"+o.Hash,BlockHash:"",From:u.From,Gas:new bignumber_js_1.default(u.Gas,16).toNumber(),GasPrice:new bignumber_js_1.default(u.GasPrice,16).toNumber(),GasUsed:new bignumber_js_1.default(u.Gas,16).toNumber(),Num:99999999999,Time:Math.floor((new Date).getTime()/1e3),To:u.To,State:"pending"},[4,i.update(tables_1.tables.tx.name,t)];case 1:return e.sent(),n={Tkn:{Currency:utils_1.default.cyToHex(u.Cy),Value:new bignumber_js_1.default(u.Value).toString(10)}},s={TxHash:o.Hash,TxType:tables_1.TxType.out,Root:o.Hash,TxHash_Root_TxType:[o.Hash,o.Hash,tables_1.TxType.out].join("_"),Num_TxHash:[t.Num,o.Hash].join("_"),Asset:n},[4,i.update(tables_1.tables.txBase.name,s)];case 2:return e.sent(),a={Num:t.Num,TxHash:t.TxHash,Currency:u.Cy,id:[pendLeft(t.Num.toString()),t.TxHash,u.Cy].join("_")},[4,db.get(r).update(tables_1.tables.txCurrency.name,a)];case 3:return e.sent(),[2]}})})}function _commitTx(l){return __awaiter(this,void 0,void 0,function(){var s,a,r,t,o,u,i;return __generator(this,function(e){switch(e.label){case 0:return s=l.From,db&&db.get(s)?[3,1]:[2,new Promise(function(e,t){t("Account is invalid! ")})];case 1:return[4,(a=db.get(s)).selectId(tables_1.tables.syncInfo.name,1)];case 2:return r=e.sent(),[4,_genPrePramas(l,r)];case 3:return t=e.sent(),console.log("preTxParam >>>> ",t),[4,tx_1.genTxParam(t,new TxGenerator,new TxState)];case 4:return(o=e.sent()).Ins&&1e3<o.Ins.length?[2,new Promise(function(e,t){t("Exceeded the maximum number of UTXOs")})]:(console.log("rest >>>> ",o),o.Z=!1,[4,jsonRpcReq("sero_commitTx",[u=tx_1.signTx(l.SK,o)])]);case 5:return i=e.sent(),[2,new Promise(function(e,t){if(i.data.error)t(i.data.error.message);else{var n=l;n.From=r.PKr,l.Data&&(n.From=r.MainPKr),_storePending(s,u,n,a).then().catch(function(e){console.error(e)}),updateUtxoTimestamp(o.Ins,s).then(function(e){console.info("rest>> ",e)}).catch(function(e){console.error(e)}),e(u.Hash)}})]}})})}function updateUtxoTimestamp(u,i){return __awaiter(this,void 0,void 0,function(){var t,n,s,a,r,o;return __generator(this,function(e){switch(e.label){case 0:t=0,n=u,e.label=1;case 1:return t<n.length?(s=n[t],a=s.Out.Root,[4,db.get(i).select(tables_1.tables.utxo.name,{Root:a})]):[3,5];case 2:return(r=e.sent())&&0<r.length?((o=r[0]).timestamp=(new Date).getTime(),[4,db.get(i).update(tables_1.tables.utxo.name,o)]):[3,4];case 3:e.sent(),e.label=4;case 4:return t++,[3,1];case 5:return[2]}})})}self.addEventListener("message",function(e){e.data&&e.data.method&&operations[e.data.method]&&operations[e.data.method](e.data)});var PKrType,TxGenerator=function(){function e(){}return e.prototype.findRoots=function(t,c,d){return __awaiter(this,void 0,void 0,function(){var l;return __generator(this,function(e){switch(e.label){case 0:return[4,db.get(t).select(tables_1.tables.utxo.name,{TK:t})];case 1:return l=e.sent(),[2,new Promise(function(e){for(var t=new Array,n=0,s=l;n<s.length;n++){var a=s[n];if(a.Asset&&a.Asset.Tkn){var r=a.Asset.Tkn;if(r&&utils_1.hexToCy(r.Currency)===c){if(d.isNeg()||d.isZero())break;var o=(new Date).getTime(),u=a.timestamp;if(u&&o-u<168e3)continue;t.push(a);var i=utils_1.default.toBN(r.Value);d=d.sub(i)}}}e({utxos:t,remain:d})})]}})})},e.prototype.findRootsByTicket=function(u,i){return __awaiter(this,void 0,void 0,function(){var t,n,s,a,r,o;return __generator(this,function(e){switch(e.label){case 0:if(t=new Array,!(i&&0<i.size))return[3,5];n=i.entries(),s=n.next(),e.label=1;case 1:return s.done?[3,5]:(a=s.value[0],[4,db.get(u).select(tables_1.tables.tickets.name,{Value:a})]);case 2:return(r=e.sent())&&0<r.length?[4,db.get(u).select(tables_1.tables.utxoTkt.name,{Root:r[0].Root})]:[3,4];case 3:o=e.sent(),t.push(o[0]),e.label=4;case 4:return s=n.next(),[3,1];case 5:return[2,new Promise(function(e){e({utxos:t,remain:new Map})})]}})})},e.prototype.getRoot=function(e){},e.prototype.defaultRefundTo=function(e){return""},e}(),TxState=function(){function e(){}return e.prototype.getAnchor=function(n){return __awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:return[4,jsonRpcReq("sero_getAnchor",[n])];case 1:return t=e.sent(),[2,new Promise(function(e){utils_1.default.isNotNull(t.error)?e(null):e(t.data.result)})]}})})},e.prototype.getPkgById=function(e){},e.prototype.getSeroGasLimit=function(e,t,n){return utils_1.default.toBN(t.Value).div(n).toNumber()},e}();function getPKrIndex(t){var e=t.data;db&&db.get(e)&&db.get(e).selectId(tables_1.tables.syncInfo.name,1).then(function(e){e.TK="",t.data=e,_postMessage(t)}).catch(function(e){t.error=e,_postMessage(t)})}function healthyCheck(t){var n=!1;if(latestSyncTime){var e=(new Date).getTime();n=e-latestSyncTime<6e4}else;var s=t.data;db.get(s).selectId(tables_1.tables.syncInfo.name,1).then(function(e){t.data={health:n,latestSyncTime:latestSyncTime,isSyncing:isSyncing.get(s),latestBlock:e.CurrentBlock,pkrIndex:e.PkrIndex},_postMessage(t)}).catch(function(e){t.data={health:n,latestSyncTime:latestSyncTime,isSyncing:isSyncing.get(s),latestBlock:0,pkrIndex:1},_postMessage(t)})}function getTxList(t){_getTxList(t).then(function(e){t.data=e,_postMessage(t)}).catch(function(e){t.error=e,_postMessage(t)})}function _genTxInfo(_,b,g){return new Promise(function(e,t){if(_){for(var n=new Map,s=new Map,a=0,r=_;a<r.length;a++){var o=r[a];if(o.Asset&&o.Asset.Tkn){var u=o.Asset.Tkn;if(u&&(!g||g&&utils_1.hexToCy(u.Currency)===g)){var i=new bignumber_js_1.default(u.Value);if(o.TxType===tables_1.TxType.out&&(i=i.multipliedBy(-1)),n.has(utils_1.hexToCy(u.Currency))){var l=i.plus(new bignumber_js_1.default(n.get(utils_1.hexToCy(u.Currency)))).toString(10);n.set(utils_1.hexToCy(u.Currency),l)}else n.set(utils_1.hexToCy(u.Currency),i.toString(10))}}if(o.Asset&&o.Asset.Tkt){var c=utils_1.hexToCy(o.Asset.Tkt.Category);if(s.has(o.Asset.Tkt)){var d=s.get(c);s.set(c,d.push(o.Asset.Tkt.Value))}else s.set(c,[o.Asset.Tkt.Value])}}var f=b;f.Tkn=n,f.Tkt=s,superzk.isMyPKr(f.TK,f.From)?f.Type="out":f.Type="in",f.TK="",f.Fee=new bignumber_js_1.default(b.GasUsed).multipliedBy(new bignumber_js_1.default(b.GasPrice)).dividedBy(new bignumber_js_1.default(10).pow(18)).toString(10),e(f)}else t(new Error("txBases not found!"))})}function _getTxList(d){return __awaiter(this,void 0,void 0,function(){var t,n,s,a,r,o,u,i,l,c;return __generator(this,function(e){switch(e.label){case 0:return t=d.data,n=t.tk,db&&db.get(n)?(s=10,t.count&&(s=t.count),[4,db.get(n).some(tables_1.tables.txCurrency.name,{Currency:t.cy},s)]):[2];case 1:if(a=e.sent(),r=[],!(a&&0<a.length))return[3,7];o=a.length-1,e.label=2;case 2:return 0<=o?(u=a[o],[4,db.get(n).select(tables_1.tables.tx.name,{Num_TxHash:[u.Num,u.TxHash].join("_")})]):[3,7];case 3:return(i=e.sent())&&0<i.length?(l=i[0],[4,db.get(n).select(tables_1.tables.txBase.name,{Num_TxHash:[u.Num,l.TxHash].join("_")})]):[3,6];case 4:return[4,_genTxInfo(e.sent(),l,t.cy)];case 5:((c=e.sent()).Tkn&&0<c.Tkn.size||c.Tkt&&0<c.Tkt.size)&&r.push(c),e.label=6;case 6:return o--,[3,2];case 7:return[2,new Promise(function(e){r.sort(function(e,t){return e.Time-t.Time}),e(r)})]}})})}function getTxDetail(t){if(db){var e=t.data;_getTxBase(e.tk,e.hash).then(function(e){t.data=e,_postMessage(t)}).catch(function(e){t.error=e.message,_postMessage(t)})}}function _getTxBase(n,s){return __awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:return[4,db.get(n).select(tables_1.tables.tx.name,{TxHash:s})];case 1:return t=e.sent(),[4,db.get(n).select(tables_1.tables.txBase.name,{TxHash:s})];case 2:return[4,_genTxInfo(e.sent(),t[0])];case 3:return[2,e.sent()]}})})}function initAccount(n){var s=n.data;if(s&&db&&!db.get(s)){var e=1;utils_1.isNewVersion(utils_1.default.toBuffer(s))&&(e=2);var a=jsuperzk.createPkrHash(s,1,e);tables_1.dbConfig.databaseName="popup_"+s;var r=new PopDB_1.PopDB(tables_1.dbConfig);db.set(s,r),r.select(tables_1.tables.syncInfo.name,{TK:s}).then(function(e){if(!e||0===e.length){var t={TK:s,PkrIndex:1,CurrentBlock:0,LastCombineBlock:0,UseHashPKr:!1,MainPKr:a,PKr:a};r.insert(tables_1.tables.syncInfo.name,t).then(function(e){n.data="success"}).catch(function(e){console.log(e),n.error=e.message})}_postMessage(n)}).catch(function(e){var t={TK:s,PkrIndex:1,CurrentBlock:0,LastCombineBlock:0,UseHashPKr:!1,MainPKr:a,PKr:a};r.insert(tables_1.tables.syncInfo.name,t).then(function(e){n.data="success"}).catch(function(e){console.log(e),n.error=e.message}),_postMessage(n)})}}function clearData(t){_clearData(t.data).then(function(e){console.log("data>>> ",e),isSyncing.clear(),t.data="Success",_postMessage(t)}).catch(function(e){console.log("data e>>> ",e),isSyncing.clear(),t.error=e,_postMessage(t)})}function _clearData(a){return __awaiter(this,void 0,void 0,function(){function t(n){return __awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:return[4,n.selectId(tables_1.tables.syncInfo.name,1)];case 1:return t=e.sent(),!0!==isSyncing.get(t.TK)?[3,3]:[4,new Promise(function(e,t){t("Data synchronization ...")})];case 2:return e.sent(),[3,15];case 3:return isSyncing.set(a,!0),assets.delete(a),t.CurrentBlock=0,t.PKr=t.MainPKr,t.PkrIndex=1,t.UseHashPKr=!1,[4,n.update(tables_1.tables.syncInfo.name,t)];case 4:return e.sent(),[4,n.clearTable(tables_1.tables.utxo.name)];case 5:return e.sent(),[4,n.clearTable(tables_1.tables.txBase.name)];case 6:return e.sent(),[4,n.clearTable(tables_1.tables.assets.name)];case 7:return e.sent(),[4,n.clearTable(tables_1.tables.assetUtxo.name)];case 8:return e.sent(),[4,n.clearTable(tables_1.tables.tx.name)];case 9:return e.sent(),[4,n.clearTable(tables_1.tables.nils.name)];case 10:return e.sent(),[4,n.clearTable(tables_1.tables.txCurrency.name)];case 11:return e.sent(),[4,n.clearTable(tables_1.tables.utxoTkt.name)];case 12:return e.sent(),[4,n.clearTable(tables_1.tables.tickets.name)];case 13:return e.sent(),[4,new Promise(function(e){e("Clear Data Success !")})];case 14:e.sent(),e.label=15;case 15:return[2]}})})}var n,s;return __generator(this,function(e){switch(e.label){case 0:return a?[4,t(db.get(a))]:[3,2];case 1:return e.sent(),[3,5];case 2:n=db.entries(),s=n.next(),e.label=3;case 3:return s.done?[3,5]:[4,t(s.value[1])];case 4:return e.sent(),s=n.next(),[3,3];case 5:return[2]}})})}function findUtxos(e,t,n){}function balancesOf(n){var s=n.data;function e(){db.get(s).selectAll(tables_1.tables.assets.name).then(function(e){var t=new Map;e&&0<e.length&&e.forEach(function(e){t.set(e.Currency,e.Amount)}),n.data=t,assets.set(s,t),_postMessage(n)}).catch(function(e){n.error=e.message,_postMessage(n)})}db&&(!0===isSyncing.get(s)&&assets.get(s)?(n.data=assets.get(s),_postMessage(n)):db.get(s)?e():setTimeout(function(){e()},500))}function ticketsOf(i){var e=i.data;db.get(e).selectAll(tables_1.tables.tickets.name).then(function(e){for(var t=new Map,n=0,s=e;n<s.length;n++){var a=s[n],r=utils_1.hexToCy(a.Category),o=a.Value;if(t.has(r)){var u=t.get(r);u.push(o),t.set(r,u)}else t.set(r,[o])}i.data=t,_postMessage(i)}).catch(function(e){i.error="string"==typeof e?e:e.message,_postMessage(i)})}function init(e){var t=e.data;t.rpc&&t.syncTime&&(rpc=t.rpc,syncTime=t.syncTime),syncIntervalId&&clearInterval(syncIntervalId),_startSync(),e.data="success",_postMessage(e)}function _postMessage(e){self.postMessage(e)}function _startSync(){function e(){fetchHandler().then(function(e){}).catch(function(e){for(var t=isSyncing.entries(),n=t.next();!n.done;)n.value[1]&&(console.log("======= recover syncing state >>> ",n.value[0],!1),isSyncing.set(n.value[0],!1)),n=t.next();console.error("======= fetchHandler error>>> ",e),sendLog("Fetch Error:","string"==typeof e?e:e.message)}),_setLatestSyncTime()}e(),syncIntervalId=setInterval(function(){e()},syncTime)}function fetchHandler(){return __awaiter(this,void 0,void 0,function(){var t,n,s,a,r,o;return __generator(this,function(e){switch(e.label){case 0:for(t=isSyncing.entries(),n=t.next();!n.done;){if(n.value[1])return[2,new Promise(function(e){e()})];n=t.next()}s=db.entries(),a=s.next(),e.label=1;case 1:return a.done?[3,4]:[4,(r=a.value[1]).selectId(tables_1.tables.syncInfo.name,1)];case 2:return o=e.sent(),!0===isSyncing.get(o.TK)?[3,1]:(isSyncing.set(o.TK,!0),[4,_fetchOuts(r,o)]);case 3:return e.sent(),isSyncing.set(o.TK,!1),a=s.next(),[3,1];case 4:return[2,new Promise(function(e){e(isSyncing)})]}})})}function changeAssets(o,u,i,l){return __awaiter(this,void 0,void 0,function(){var t,n,s,a,r;return __generator(this,function(e){switch(e.label){case 0:return u.Asset.Tkn?(t=[u.Root,l].join("_"),[4,i.select(tables_1.tables.assetUtxo.name,{RootType:t})]):[3,10];case 1:return n=e.sent(),o&&0<o.length?n&&0<n.length?(console.log("asset utxo has set!!",u.Root),[3,5]):[3,2]:[3,6];case 2:return r=o[0],a=new bignumber_js_1.default(u.Asset.Tkn.Value),l===tables_1.TxType.out&&(a=a.multipliedBy(-1)),r.Amount=new bignumber_js_1.default(r.Amount).plus(a).toString(10),(s=u).RootType=t,[4,i.update(tables_1.tables.assetUtxo.name,s)];case 3:return e.sent(),[4,i.update(tables_1.tables.assets.name,r)];case 4:e.sent(),e.label=5;case 5:return[3,10];case 6:return n&&0<n.length?(console.log("asset utxo has set!!!",u.Root),[3,10]):[3,7];case 7:return(s=u).RootType=t,[4,i.update(tables_1.tables.assetUtxo.name,s)];case 8:return e.sent(),u.Asset.Tkn?(a=u.Asset.Tkn.Value,l===tables_1.TxType.out&&(a=new bignumber_js_1.default(u.Asset.Tkn.Value).multipliedBy(-1).toString(10)),r={Currency:utils_1.default.hexToCy(u.Asset.Tkn.Currency),Amount:a},[4,i.insert(tables_1.tables.assets.name,r)]):[3,10];case 9:e.sent(),e.label=10;case 10:return[2]}})})}function _deletePending(t,n){t.select(tables_1.tables.tx.name,{Num_TxHash:["99999999999",n.TxHash].join("_")}).then(function(e){e&&0<e.length&&(t.delete(tables_1.tables.txBase.name,{TxHash_Root_TxType:[n.TxHash,n.TxHash,tables_1.TxType.out].join("_")}).then(function(e){}).catch(function(e){console.log(e.message)}),t.delete(tables_1.tables.tx.name,{Num_TxHash:["99999999999",n.TxHash].join("_")}).then(function(e){}).catch(function(e){console.log(e.message)}),t.delete(tables_1.tables.txCurrency.name,{Num:99999999999,TxHash:n.TxHash}).then(function(e){}).catch(function(e){console.log(e.message)}))}).catch(function(e){console.log(e.message)})}function _fetchOuts(l,c){return __awaiter(this,void 0,void 0,function(){var t,n,s,a,r,o,u,i;return __generator(this,function(e){switch(e.label){case 0:if(!l)return[2,new Promise(function(e,t){t("POPDB not init")})];n=(t=c).CurrentBlock,s=null,a=c.PkrIndex,r=!1,e.label=1;case 1:return[4,fetchAndIndex(c.TK,a,c.UseHashPKr,n,s)];case 2:return(o=e.sent()).utxos&&0<o.utxos.length&&(console.log("rtn.utxos.length>>",o.utxos.length),r=!0),[4,_indexUtxos(o,c.TK,l)];case 3:return e.sent(),o.useHashPKr&&(t.UseHashPKr=!0),!0!==o.again?[3,5]:(t.PkrIndex=t.PkrIndex+1,u=1,utils_1.isNewVersion(utils_1.default.toBuffer(c.TK))&&(u=2),t.PKr=jsuperzk.createPkrHash(c.TK,t.PkrIndex,u),s=o.lastBlockNumber,a=t.PkrIndex,t.CurrentBlock=o.lastBlockNumber,[4,l.update(tables_1.tables.syncInfo.name,t)]);case 4:return e.sent(),[3,6];case 5:return latestBlock=o.lastBlockNumber,t.CurrentBlock=o.lastBlockNumber,[3,7];case 6:return[3,1];case 7:return[4,l.update(tables_1.tables.syncInfo.name,t)];case 8:return e.sent(),[4,_checkNil(c.TK)];case 9:return i=e.sent(),console.log("_checkNil>> ",i,r),!0!==r&&!0!==i?[3,11]:[4,calAssets(l)];case 10:e.sent(),e.label=11;case 11:return[4,_syncPendingAndConfirm(c.TK)];case 12:return e.sent(),[2]}})})}function _indexUtxos(f,_,b){return __awaiter(this,void 0,void 0,function(){var t,n,s,a,r,o,u,i,l,c,d;return __generator(this,function(e){switch(e.label){case 0:if(!(f.utxos&&0<f.utxos.length))return[3,11];t=0,n=f.utxos,e.label=1;case 1:if(!(t<n.length))return[3,11];if((s=n[t]).TK=_,!s.Nils)return[3,5];a=0,r=s.Nils,e.label=2;case 2:return a<r.length?(o=r[a],u={Nil:o,Root:s.Root},[4,b.update(tables_1.tables.nils.name,u)]):[3,5];case 3:e.sent(),e.label=4;case 4:return a++,[3,2];case 5:return s.Asset.Tkn?[4,b.update(tables_1.tables.utxo.name,s)]:[3,7];case 6:e.sent(),e.label=7;case 7:return s.Asset.Tkt?(i=s,[4,b.update(tables_1.tables.utxoTkt.name,i)]):[3,10];case 8:return e.sent(),console.log("indexTickets>> ",{Root:i.Root,Value:s.Asset.Tkt.Value,Category:s.Asset.Tkt.Category}),[4,b.update(tables_1.tables.tickets.name,{Root:i.Root,Value:s.Asset.Tkt.Value,Category:s.Asset.Tkt.Category})];case 9:e.sent(),e.label=10;case 10:return t++,[3,1];case 11:if(!(f.txInfos&&0<f.txInfos.length))return[3,15];l=0,c=f.txInfos,e.label=12;case 12:return l<c.length?((d=c[l]).TK=_,d.Num_TxHash=d.Num+"_"+d.TxHash,_deletePending(b,d),[4,b.update(tables_1.tables.tx.name,d)]):[3,15];case 13:e.sent(),e.label=14;case 14:return l++,[3,12];case 15:return[2]}})})}function fetchAndIndex(A,N,S,K,I){return __awaiter(this,void 0,void 0,function(){var t,n,s,a,r,o,u,i,l,c,d,f,_,b,g,h,m,T,x,p,y,v,k,w,P,C,H;return __generator(this,function(e){switch(e.label){case 0:return t=genPKrs(A,N,S),n=[],n=I&&0<I?(s=[],t.CurrentPKrMap.forEach(function(e,t){s.push(t)}),[s,K,I]):[t.PKrs,K,null],sendLog("("+t.pkrMain+")Fetch",JSON.stringify({pkrIndex:N,start:K})),[4,jsonRpcReq("light_getOutsByPKr",n)];case 1:if(a=e.sent(),r=a.data,i=u=!(o={utxos:null,again:!1,useHashPKr:!1,remoteNum:0,nextNum:0,lastBlockNumber:0,txInfos:null}),!r.result)return[3,14];if(l=r.result.BlockOuts,c=[],d=[],!(l&&0<l.length))return[3,13];f=0,_=l,e.label=2;case 2:if(!(f<_.length))return[3,13];b=_[f],g=b.Data,h=0,m=g,e.label=3;case 3:return h<m.length?(T=m[h],x=T.TxInfo,p=jsuperzk.decOut(A,[T.Out]),x.Root=T.Out.Root,y={TxHash:x.TxHash,TxType:tables_1.TxType.in,Root:T.Out.Root,Asset:p[0].Asset,TxHash_Root_TxType:[x.TxHash,x.Root,tables_1.TxType.in].join("_"),Num_TxHash:[x.Num,x.TxHash].join("_")},c.push(x),p[0].Asset&&p[0].Asset.Tkn?(v=utils_1.default.hexToCy(p[0].Asset.Tkn.Currency),k={Num:x.Num,TxHash:x.TxHash,Currency:v,id:[pendLeft(x.Num.toString()),x.TxHash,v].join("_")},[4,db.get(A).select(tables_1.tables.assets.name,{Currency:v})]):[3,9]):[3,12];case 4:return(w=e.sent())&&0<w.length?[3,7]:[3,5];case 5:return[4,db.get(A).insert(tables_1.tables.assets.name,{Currency:v,Amount:"0"})];case 6:e.sent(),e.label=7;case 7:return[4,db.get(A).update(tables_1.tables.txCurrency.name,k)];case 8:e.sent(),sendLog("("+t.pkrMain+") AddTx",JSON.stringify({Block:k.Num,TxHash:k.TxHash})),e.label=9;case 9:return[4,db.get(A).update(tables_1.tables.txBase.name,y)];case 10:e.sent(),d=d.concat(p),e.label=11;case 11:return h++,[3,3];case 12:return f++,[3,2];case 13:for(P=0,C=d;P<C.length;P++)H=C[P],t.CurrentPKrMap.has(H.Pkr)&&(o.again=!0),S||(t.PKrTypeMap.get(H.Pkr)===PKrType.New?u=!0:t.PKrTypeMap.get(H.Pkr)===PKrType.Old&&(i=!0));return o.txInfos=c,o.utxos=d,o.lastBlockNumber=r.result.CurrentNum,o.remoteNum=r.result.CurrentNum,S||!u||i||(o.useHashPKr=!0),[2,new Promise(function(e,t){e(o)})];case 14:return[2]}})})}function sendLog(e,t){var n={type:"ServiceLog"};n.operator=e,n.content=t,_postMessage(n)}function jsonRpcReq(a,r){return new Promise(function(t,n){if(!rpc){var e=(new Date).getTimezoneOffset()/60;rpc=-8==e?"https://sero-light-node.ririniannian.com":"https://f-sero-light-node.ririniannian.com"}var s={id:rpcId++,jsonrpc:"2.0",method:a,params:r};return axios_1.default.post(rpc,s).then(function(e){t(e)}).catch(function(e){n(e)})})}function genPKrs(e,t,n){var s=new Array,a=new Map,r=new Map,o=1,u=utils_1.isNewVersion(utils_1.default.toBuffer(e));u&&(o=2);var i=1;5<t&&(i=t-5);for(var l=jsuperzk.createPkrHash(e,1,o),c=t;i<=c;c--){var d=jsuperzk.createPkrHash(e,c,o);a.set(d,PKrType.New),s.push(d),c===t&&r.set(d,!0)}if(-1===s.indexOf(l)&&s.push(l),!u){var f=jsuperzk.createOldPkrHash(e,1,o);if(!n)for(c=t;i<=c;c--){var _=jsuperzk.createOldPkrHash(e,c,o);a.set(_,PKrType.Old),s.push(_),c===t&&r.set(_,!0)}-1===s.indexOf(f)&&s.push(f)}return{PKrTypeMap:a,CurrentPKrMap:r,PKrs:s,pkrMain:ellipsisHash(l)}}function ellipsisHash(t){try{return t.substring(0,5)+"..."+t.substring(t.length-5)}catch(e){return t}}function _checkNil(x){return __awaiter(this,void 0,void 0,function(){function t(T){return __awaiter(this,void 0,void 0,function(){var t,n,s,a,r,o,u,i,l,c,d,f,_,b,g,h,m;return __generator(this,function(e){switch(e.label){case 0:return[4,jsonRpcReq("light_checkNil",[T])];case 1:if(!((t=e.sent())&&t.data&&t.data.result))return[3,18];if(!((n=t.data.result)&&0<n.length))return[3,17];s=0,a=n,e.label=2;case 2:return s<a.length?(r=a[s],o=r.TxInfo,u={Nil:r.Nil},o.TK=x,o.Num_TxHash=o.Num+"_"+o.TxHash,_deletePending(db.get(x),o),[4,db.get(x).select(tables_1.tables.nils.name,u)]):[3,16];case 3:if(!((i=e.sent())&&0<i.length))return[3,13];l=0,c=i,e.label=4;case 4:return l<c.length?(d=c[l],[4,db.get(x).delete(tables_1.tables.nils.name,u)]):[3,13];case 5:return e.sent(),f=d.Root,[4,db.get(x).select(tables_1.tables.utxo.name,{Root:f})];case 6:return _=e.sent(),[4,db.get(x).delete(tables_1.tables.tickets.name,{Root:f})];case 7:return e.sent(),[4,db.get(x).delete(tables_1.tables.utxoTkt.name,{Root:f})];case 8:return e.sent(),_?(b=_[0])?(g={TxHash:o.TxHash,TxType:tables_1.TxType.out,Root:f,Asset:b.Asset,TxHash_Root_TxType:[o.TxHash,f,tables_1.TxType.out].join("_"),Num_TxHash:[o.Num,o.TxHash].join("_")},[4,db.get(x).update(tables_1.tables.txBase.name,g)]):[3,12]:[3,12];case 9:return e.sent(),[4,db.get(x).delete(tables_1.tables.utxo.name,{Root:f})];case 10:return e.sent(),sendLog("Remove UTXO",JSON.stringify({Root:f})),b.Asset&&b.Asset.Tkn?(h=utils_1.default.hexToCy(b.Asset.Tkn.Currency),m={Num:o.Num,TxHash:o.TxHash,Currency:utils_1.default.hexToCy(b.Asset.Tkn.Currency),id:[pendLeft(o.Num.toString()),o.TxHash,h].join("_")},[4,db.get(x).update(tables_1.tables.txCurrency.name,m)]):[3,12];case 11:e.sent(),e.label=12;case 12:return l++,[3,4];case 13:return[4,db.get(x).update(tables_1.tables.tx.name,o)];case 14:e.sent(),e.label=15;case 15:return s++,[3,2];case 16:return[2,!0];case 17:case 18:return[2,!1]}})})}var n,s,a,r,o,u;return __generator(this,function(e){switch(e.label){case 0:return[4,db.get(x).selectAll(tables_1.tables.nils.name)];case 1:n=e.sent(),s=!1,a=new Array,r=0,o=n,e.label=2;case 2:return r<o.length?(u=o[r],a.push(u.Nil),1e3<=a.length?[4,t(a)]:[3,4]):[3,5];case 3:!0===e.sent()&&!1===s&&(s=!0),a=new Array,e.label=4;case 4:return r++,[3,2];case 5:return a&&0<a.length?[4,t(a)]:[3,7];case 6:!0===e.sent()&&!1===s&&(s=!0),e.label=7;case 7:return[2,s]}})})}function getPendingAndConfirming(n){return __awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(e){return t=n.data,pendingAndConirmMap.has(t)?n.data=pendingAndConirmMap.get(t):n.data=[],_postMessage(n),[2]})})}function _syncPendingAndConfirm(S){return __awaiter(this,void 0,void 0,function(){var t,n,s,a,r,o,u,i,l,c,d,f,_,b,g,h,m,T,x,p,y,v,k,w,P,C,H,A,N;return __generator(this,function(e){switch(e.label){case 0:return[4,db.get(S).selectId(tables_1.tables.syncInfo.name,1)];case 1:return t=e.sent(),[4,jsonRpcReq("light_getPendingOuts",[genPKrs(S,t.PkrIndex,!0).PKrs])];case 2:if(n=e.sent(),s=[],n&&n.data&&n.data.result&&(a=n.data.result.BlockOuts)&&0<a.length){for(r=new Map,o=0,u=a;o<u.length;o++)for(i=u[o],T=i.Data,l=0,c=T;l<c.length;l++)d=c[l],f=d.TxInfo.TxHash,r.has(f)?((_=r.get(f)).push(d),r.set(f,_)):r.set(f,[d]);for(b=r.entries(),g=b.next();!g.done;){for(h=g.value[1],m=h[0].TxInfo,T=[],x=0,p=h;x<p.length;x++)y=p[x],T.push(y.Out);for(v=jsuperzk.decOut(S,T),k=new Map,w=0,P=v;w<P.length;w++)C=P[w],(H=C.Asset).Tkn&&(A=utils_1.default.hexToCy(H.Tkn.Currency),k.has(A)?(N=k.get(A),k.set(A,new bignumber_js_1.default(N).plus(new bignumber_js_1.default(H.Tkn.Value)).toString(10))):k.set(A,new bignumber_js_1.default(H.Tkn.Value).toString(10)));m.Tkn=k,m.isConfirm=!0,s.push(m),g=b.next()}}return pendingAndConirmMap.set(S,s),[2]}})})}function _setLatestSyncTime(){latestSyncTime=(new Date).getTime()}function pendLeft(e){for(var t="a",n=0;n<12-e.length;n++)t+="0";return t+e}!function(e){e[e.New=0]="New",e[e.Old=1]="Old"}(PKrType=PKrType||{});