"use strict";var __awaiter=this&&this.__awaiter||function(e,u,o,c){return new(o=o||Promise)(function(n,t){function s(e){try{r(c.next(e))}catch(e){t(e)}}function a(e){try{r(c.throw(e))}catch(e){t(e)}}function r(e){var t;e.done?n(e.value):((t=e.value)instanceof o?t:new o(function(e){e(t)})).then(s,a)}r((c=c.apply(e,u||[])).next())})},__generator=this&&this.__generator||function(n,s){var a,r,u,e,o={label:0,sent:function(){if(1&u[0])throw u[1];return u[1]},trys:[],ops:[]};return e={next:t(0),throw:t(1),return:t(2)},"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(a)throw new TypeError("Generator is already executing.");for(;o;)try{if(a=1,r&&(u=2&t[0]?r.return:t[0]?r.throw||((u=r.return)&&u.call(r),0):r.next)&&!(u=u.call(r,t[1])).done)return u;switch(r=0,u&&(t=[2&t[0],u.value]),t[0]){case 0:case 1:u=t;break;case 4:return o.label++,{value:t[1],done:!1};case 5:o.label++,r=t[1],t=[0];continue;case 7:t=o.ops.pop(),o.trys.pop();continue;default:if(!(u=0<(u=o.trys).length&&u[u.length-1])&&(6===t[0]||2===t[0])){o=0;continue}if(3===t[0]&&(!u||t[1]>u[0]&&t[1]<u[3])){o.label=t[1];break}if(6===t[0]&&o.label<u[1]){o.label=u[1],u=t;break}if(u&&o.label<u[2]){o.label=u[2],o.ops.push(t);break}u[2]&&o.ops.pop(),o.trys.pop();continue}t=s.call(n,o)}catch(e){t=[6,e],r=0}finally{a=u=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}};Object.defineProperty(exports,"__esModule",{value:!0});var PopDB_1=require("../db/PopDB"),types_1=require("./types"),tables_1=require("./tables"),utils_1=require("jsuperzk/dist/utils/utils"),axios_1=require("axios"),bignumber_js_1=require("bignumber.js"),jsuperzk=require("jsuperzk/dist/index"),superzk=require("jsuperzk/dist/protocol/account"),tx_1=require("jsuperzk/dist/tx/tx"),db=new Map,assets=new Map,latestSyncTime=(new Date).getTime(),latestBlock=0,syncIntervalId=null,isSyncing=!1,syncTime=1e4,rpc=null,rpcId=0,operations={init:init,healthyCheck:healthyCheck,initAccount:initAccount,clearData:clearData,findUtxos:findUtxos,balanceOf:balancesOf,ticketsOf:ticketsOf,getTxList:getTxList,getTxDetail:getTxDetail,getPKrIndex:getPKrIndex,commitTx:commitTx,getSeroPrice:getSeroPrice};function getSeroPrice(n){var e=n.data;axios_1.default.get("https://data.gateio.co/api2/1/ticker/"+e).then(function(e){if(e&&e.data){var t=e.data;n.data=t,_postMessage(n)}}).catch(function(e){})}function commitTx(t){var e=t.data;try{_commitTx(e).then(function(e){t.data=e,_postMessage(t)}).catch(function(e){t.error=e,_postMessage(t)})}catch(e){t.error=e.message,_postMessage(t)}}function _genPrePramas(e,t){var n=e.From,s=e.To,a=e.Value,r=e.Cy,u=e.Data,o=e.Gas,c=e.GasPrice;r=r||"SERO",o=o||"0x"+new bignumber_js_1.default("4700000").toString(16),c=c||"0x"+new bignumber_js_1.default("1000000000").toString(16);var i={Currency:utils_1.default.cyToHex(r),Value:utils_1.default.toBN(a).toString(10)},l={Currency:utils_1.default.cyToHex("SERO"),Value:new bignumber_js_1.default(c,16).multipliedBy(new bignumber_js_1.default(o,16)).toString(10)},f={Addr:s,Asset:{Tkn:i}},_={From:n,RefundTo:t.PKr,Fee:l,GasPrice:utils_1.default.toBN(c).toString(10),Cmds:null,Receptions:[f]};return u&&(_.Receptions=[],_.RefundTo=t.MainPKr,_.Cmds={Contract:{Data:u,To:utils_1.default.bs58ToHex(s)+"0000000000000000000000000000000000000000000000000000000000000000",Asset:{Tkn:{Currency:utils_1.default.cyToHex(r),Value:utils_1.default.toBN(a).toString()}}}}),_}function _storePending(r,u,o,c){return __awaiter(this,void 0,void 0,function(){var t,n,s,a;return __generator(this,function(e){switch(e.label){case 0:return t={TK:r,TxHash:u.Hash,Num_TxHash:"99999999999_"+u.Hash,BlockHash:"",From:o.From,Gas:new bignumber_js_1.default(o.Gas,16).toNumber(),GasPrice:new bignumber_js_1.default(o.GasPrice,16).toNumber(),GasUsed:new bignumber_js_1.default(o.Gas,16).toNumber(),Num:99999999999,Time:Math.floor((new Date).getTime()/1e3),To:o.To,State:"pending"},[4,c.update(tables_1.tables.tx.name,t)];case 1:return e.sent(),n={Tkn:{Currency:utils_1.default.cyToHex(o.Cy),Value:new bignumber_js_1.default(o.Value).toString(10)}},s={TxHash:u.Hash,TxType:tables_1.TxType.out,Root:u.Hash,TxHash_Root_TxType:[u.Hash,u.Hash,tables_1.TxType.out].join("_"),Num_TxHash:[t.Num,u.Hash].join("_"),Asset:n},[4,c.update(tables_1.tables.txBase.name,s)];case 2:return e.sent(),a={Num:t.Num,TxHash:t.TxHash,Currency:o.Cy,id:[t.Num,t.TxHash,o.Cy].join("_")},[4,db.get(r).update(tables_1.tables.txCurrency.name,a)];case 3:return e.sent(),[2]}})})}function _commitTx(c){return __awaiter(this,void 0,void 0,function(){var s,a,r,t,n,u,o;return __generator(this,function(e){switch(e.label){case 0:return s=c.From,db&&db.get(s)?[3,1]:[2,new Promise(function(e,t){t("Account is invalid! ")})];case 1:return[4,(a=db.get(s)).selectId(tables_1.tables.syncInfo.name,1)];case 2:return r=e.sent(),t=_genPrePramas(c,r),[4,tx_1.genTxParam(t,new TxGenerator,new TxState)];case 3:return(n=e.sent()).Z=!1,[4,jsonRpcReq("sero_commitTx",[u=tx_1.signTx(c.SK,n)])];case 4:return o=e.sent(),[2,new Promise(function(e,t){if(o.data.result)t(o.data);else{var n=c;n.From=r.PKr,c.Data&&(n.From=r.MainPKr),_storePending(s,u,n,a).then().catch(function(e){console.log("e:",e)}),e(u.Hash)}})]}})})}self.addEventListener("message",function(e){e.data&&e.data.method&&operations[e.data.method]&&operations[e.data.method](e.data)});var PKrType,TxGenerator=function(){function e(){}return e.prototype.findRoots=function(l,f,_){return __awaiter(this,void 0,void 0,function(){var i;return __generator(this,function(e){switch(e.label){case 0:return[4,db.get(l).select(tables_1.tables.utxo.name,{TK:l})];case 1:return i=e.sent(),[2,new Promise(function(e){for(var t=new Array,n=0,s=i;n<s.length;n++){var a=s[n];if(a.Asset&&a.Asset.Tkn){var r=a.Asset.Tkn;if(utils_1.hexToCy(r.Currency)===f){var u=(new Date).getTime(),o=a.timestamp;if(o&&u-o<18e4)continue;a.timestamp=u,db.get(l).update(tables_1.tables.utxo.name,a),t.push(a);var c=utils_1.default.toBN(r.Value);if((_=_.sub(c)).isNeg()||_.isZero())break}}}e({utxos:t,remain:_})})]}})})},e.prototype.findRootsByTicket=function(e,t){return new Promise(function(e){e({utxos:[],remain:new Map})})},e.prototype.getRoot=function(e){},e.prototype.defaultRefundTo=function(e){return""},e}(),TxState=function(){function e(){}return e.prototype.getAnchor=function(n){return __awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:return[4,jsonRpcReq("sero_getAnchor",[n])];case 1:return t=e.sent(),[2,new Promise(function(e){utils_1.default.isNotNull(t.error)?e(null):e(t.data.result)})]}})})},e.prototype.getPkgById=function(e){},e.prototype.getSeroGasLimit=function(e,t,n){return utils_1.default.toBN(t.Value).div(n).toNumber()},e}();function getPKrIndex(t){var e=t.data;db&&db.get(e)&&db.get(e).selectId(tables_1.tables.syncInfo.name,1).then(function(e){e.TK="",t.data=e,_postMessage(t)}).catch(function(e){t.error=e,_postMessage(t)})}function healthyCheck(t){var n=!1;if(latestSyncTime){var e=(new Date).getTime();n=e-latestSyncTime<6e4}else;var s=t.data;db.get(s).selectId(tables_1.tables.syncInfo.name,1).then(function(e){t.data={health:n,latestSyncTime:latestSyncTime,isSyncing:isSyncing,latestBlock:e.CurrentBlock,pkrIndex:e.PkrIndex},_postMessage(t)}).catch(function(e){t.data={health:n,latestSyncTime:latestSyncTime,isSyncing:isSyncing,latestBlock:0,pkrIndex:1},_postMessage(t)})}function getTxList(t){_getTxList(t).then(function(e){t.data=e,_postMessage(t)}).catch(function(e){t.error=e,_postMessage(t)})}function _genTxInfo(_,d,b){return new Promise(function(e,t){if(_){for(var n=new Map,s=new Map,a=0,r=_;a<r.length;a++){var u=r[a];if(u.Asset&&u.Asset.Tkn){var o=u.Asset.Tkn;if(!b||b&&utils_1.hexToCy(o.Currency)===b){var c=new bignumber_js_1.default(o.Value);if(u.TxType===tables_1.TxType.out&&(c=c.multipliedBy(-1)),n.has(utils_1.hexToCy(o.Currency))){var i=c.plus(new bignumber_js_1.default(n.get(utils_1.hexToCy(o.Currency)))).toString(10);n.set(utils_1.hexToCy(o.Currency),i)}else n.set(utils_1.hexToCy(o.Currency),c.toString(10))}}if(u.Asset&&u.Asset.Tkt)if(s.has(u.Asset.Tkt)){var l=s.get(u.Asset.Tkt.Category);s.set(u.Asset.Tkt.Category,l.push(u.Asset.Tkt.Value))}else s.set(u.Asset.Tkt.Category,[u.Asset.Tkt.Value])}var f=d;f.Tkn=n,f.Tkt=s,superzk.isMyPKr(f.TK,f.From)?f.Type="out":f.Type="in",f.TK="",f.Fee=new bignumber_js_1.default(d.GasUsed).multipliedBy(new bignumber_js_1.default(d.GasPrice)).dividedBy(new bignumber_js_1.default(10).pow(18)).toString(10),e(f)}else t(new Error("txBases not found!"))})}function _getTxList(f){return __awaiter(this,void 0,void 0,function(){var t,n,s,a,r,u,o,c,i,l;return __generator(this,function(e){switch(e.label){case 0:return t=f.data,n=t.tk,db&&db.get(n)?(s=10,t.count&&(s=t.count),[4,db.get(n).some(tables_1.tables.txCurrency.name,{Currency:t.cy},s)]):[2];case 1:if(a=e.sent(),r=[],!(a&&0<a.length))return[3,7];u=a.length-1,e.label=2;case 2:return 0<=u?(o=a[u],[4,db.get(n).select(tables_1.tables.tx.name,{Num_TxHash:[o.Num,o.TxHash].join("_")})]):[3,7];case 3:return(c=e.sent())&&0<c.length?(i=c[0],[4,db.get(n).select(tables_1.tables.txBase.name,{Num_TxHash:[o.Num,i.TxHash].join("_")})]):[3,6];case 4:return[4,_genTxInfo(e.sent(),i,t.cy)];case 5:((l=e.sent()).Tkn&&0<l.Tkn.size||l.Tkt&&0<l.Tkt.size)&&r.push(l),e.label=6;case 6:return u--,[3,2];case 7:return[2,new Promise(function(e){r.sort(function(e,t){return e.Time-t.Time}),e(r)})]}})})}function getTxDetail(t){if(db){var e=t.data;_getTxBase(e.tk,e.hash).then(function(e){t.data=e,_postMessage(t)}).catch(function(e){t.error=e.message,_postMessage(t)})}}function _getTxBase(n,s){return __awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:return[4,db.get(n).select(tables_1.tables.tx.name,{TxHash:s})];case 1:return t=e.sent(),[4,db.get(n).select(tables_1.tables.txBase.name,{TxHash:s})];case 2:return[4,_genTxInfo(e.sent(),t[0])];case 3:return[2,e.sent()]}})})}function initAccount(n){var s=n.data;if(s&&db&&!db.get(s)){var e=1;utils_1.isNewVersion(utils_1.default.toBuffer(s))&&(e=2);var a=jsuperzk.createPkrHash(s,1,e);tables_1.dbConfig.databaseName="popup_"+s;var r=new PopDB_1.PopDB(tables_1.dbConfig);db.set(s,r),r.select(tables_1.tables.syncInfo.name,{TK:s}).then(function(e){if(!e||0===e.length){var t={TK:s,PkrIndex:1,CurrentBlock:0,LastCombineBlock:0,UseHashPKr:!1,MainPKr:a,PKr:a};r.insert(tables_1.tables.syncInfo.name,t).then(function(e){n.data="success"}).catch(function(e){console.log(e),n.error=e.message})}_postMessage(n)}).catch(function(e){var t={TK:s,PkrIndex:1,CurrentBlock:0,LastCombineBlock:0,UseHashPKr:!1,MainPKr:a,PKr:a};r.insert(tables_1.tables.syncInfo.name,t).then(function(e){n.data="success"}).catch(function(e){console.log(e),n.error=e.message}),_postMessage(n)})}}function clearData(t){_clearData(t.data).then(function(e){isSyncing=!1,t.data="Success",_postMessage(t)}).catch(function(e){isSyncing=!1,t.error=e.message,_postMessage(t)})}function _clearData(a){return __awaiter(this,void 0,void 0,function(){function t(n){return __awaiter(this,void 0,void 0,function(){var t;return __generator(this,function(e){switch(e.label){case 0:return[4,n.clearTable(tables_1.tables.utxo.name)];case 1:return e.sent(),[4,n.clearTable(tables_1.tables.txBase.name)];case 2:return e.sent(),[4,n.clearTable(tables_1.tables.assets.name)];case 3:return e.sent(),[4,n.clearTable(tables_1.tables.assetUtxo.name)];case 4:return e.sent(),[4,n.clearTable(tables_1.tables.tx.name)];case 5:return e.sent(),[4,n.clearTable(tables_1.tables.nils.name)];case 6:return e.sent(),[4,n.clearTable(tables_1.tables.txCurrency.name)];case 7:return e.sent(),[4,n.selectId(tables_1.tables.syncInfo.name,1)];case 8:return(t=e.sent()).CurrentBlock=0,t.PKr=t.MainPKr,t.PkrIndex=1,t.UseHashPKr=!1,[4,n.update(tables_1.tables.syncInfo.name,t)];case 9:return e.sent(),[2]}})})}var n,s;return __generator(this,function(e){switch(e.label){case 0:return!1!==isSyncing?[3,6]:(isSyncing=!0,a?(assets.delete(a),[4,t(db.get(a))]):[3,2]);case 1:return e.sent(),[3,5];case 2:assets.clear(),n=db.entries(),s=n.next(),e.label=3;case 3:return s.done?[3,5]:[4,t(s.value[1])];case 4:return e.sent(),s=n.next(),[3,3];case 5:return[2,new Promise(function(e){e("Data clear success!")})];case 6:return[2,new Promise(function(e,t){t("Data synchronization...")})];case 7:return[2]}})})}function findUtxos(e,t,n){}function balancesOf(n){var s=n.data;function e(){db.get(s).selectAll(tables_1.tables.assets.name).then(function(e){var t=new Map;e&&0<e.length&&e.forEach(function(e){t.set(e.Currency,e.Amount)}),n.data=t,assets.set(s,t),_postMessage(n)}).catch(function(e){n.error=e.message,_postMessage(n)})}db&&(isSyncing?(n.data=assets.get(s),_postMessage(n)):db.get(s)?e():setTimeout(function(){e()},1e3))}function ticketsOf(e){return{method:types_1.Method.BalanceOf,data:"success",error:null}}function init(e){var t=e.data;t.rpc&&t.syncTime&&(rpc=t.rpc,syncTime=t.syncTime),syncIntervalId&&clearInterval(syncIntervalId),isSyncing=!1,_startSync(),e.data="success",_postMessage(e)}function _postMessage(e){self.postMessage(e)}function _startSync(){function e(){isSyncing||fetchHandler().then(function(e){}).catch(function(e){console.log("======= fetchHandler error>>> ",e),isSyncing=!1}),_setLatestSyncTime()}e(),syncIntervalId=setInterval(function(){e()},syncTime)}function fetchHandler(){return __awaiter(this,void 0,void 0,function(){var t,n;return __generator(this,function(e){switch(e.label){case 0:t=db.entries(),n=t.next(),isSyncing=!0,e.label=1;case 1:return n.done?[3,3]:[4,_fetchOuts(n.value[1])];case 2:return e.sent(),n=t.next(),[3,1];case 3:return isSyncing=!1,[2,new Promise(function(e){e(isSyncing)})]}})})}function changeAssets(u,o,c,i){return __awaiter(this,void 0,void 0,function(){var t,n,s,a,r;return __generator(this,function(e){switch(e.label){case 0:return o.Asset.Tkn?(t=[o.Root,i].join("_"),[4,c.select(tables_1.tables.assetUtxo.name,{RootType:t})]):[3,10];case 1:return n=e.sent(),u&&0<u.length?n&&0<n.length?(console.log("asset utxo has set!!",o.Root),[3,5]):[3,2]:[3,6];case 2:return r=u[0],a=new bignumber_js_1.default(o.Asset.Tkn.Value),i===tables_1.TxType.out&&(a=a.multipliedBy(-1)),r.Amount=new bignumber_js_1.default(r.Amount).plus(a).toString(10),(s=o).RootType=t,[4,c.update(tables_1.tables.assetUtxo.name,s)];case 3:return e.sent(),[4,c.update(tables_1.tables.assets.name,r)];case 4:e.sent(),e.label=5;case 5:return[3,10];case 6:return n&&0<n.length?(console.log("asset utxo has set!!!",o.Root),[3,10]):[3,7];case 7:return(s=o).RootType=t,[4,c.update(tables_1.tables.assetUtxo.name,s)];case 8:return e.sent(),a=o.Asset.Tkn.Value,i===tables_1.TxType.out&&(a=new bignumber_js_1.default(o.Asset.Tkn.Value).multipliedBy(-1).toString(10)),r={Currency:utils_1.default.hexToCy(o.Asset.Tkn.Currency),Amount:a},[4,c.insert(tables_1.tables.assets.name,r)];case 9:e.sent(),e.label=10;case 10:return[2]}})})}function _deletePending(t,n){t.select(tables_1.tables.tx.name,{Num_TxHash:["99999999999",n.TxHash].join("_")}).then(function(e){e&&0<e.length&&(t.delete(tables_1.tables.txBase.name,{TxHash_Root_TxType:[n.TxHash,n.TxHash,tables_1.TxType.out].join("_")}).then(function(e){}).catch(function(e){console.log(e.message)}),t.delete(tables_1.tables.tx.name,{Num_TxHash:["99999999999",n.TxHash].join("_")}).then(function(e){}).catch(function(e){console.log(e.message)}),t.delete(tables_1.tables.txCurrency.name,{TxHash:n.TxHash}).then(function(e){}).catch(function(e){console.log(e.message)}))}).catch(function(e){console.log(e.message)})}function _fetchOuts(m){return __awaiter(this,void 0,void 0,function(){var t,n,s,a,r,u,o,c,i,l,f,_,d,b,h,g,T;return __generator(this,function(e){switch(e.label){case 0:return m?[4,m.selectAll(tables_1.tables.syncInfo.name)]:[2];case 1:t=e.sent(),n=0,s=t,e.label=2;case 2:return n<s.length?(a=s[n],u=0,o=null,c=(r=a).PkrIndex,a.CurrentBlock&&0!==a.CurrentBlock?[3,9]:[4,jsonRpcReq("sero_blockNumber",["latest"])]):[3,17];case 3:i=e.sent(),l=i.data,f=new bignumber_js_1.default(l.result,16).toNumber(),_=u,d=1e5,b=Math.ceil((f-_)/d),console.log("pageTotal>>",f,b),g=void 0,h=0,e.label=4;case 4:return h<b?(o=_+d,[4,fetchAndIndex(a.TK,1,a.UseHashPKr,_,o)]):[3,8];case 5:return[4,_indexUtxos(g=e.sent(),a.TK,m)];case 6:e.sent(),_=o,e.label=7;case 7:return h++,[3,4];case 8:return o=g.lastBlockNumber,c=2,[3,10];case 9:u=a.CurrentBlock,e.label=10;case 10:return[4,fetchAndIndex(a.TK,c,a.UseHashPKr,u,o)];case 11:return[4,_indexUtxos(g=e.sent(),a.TK,m)];case 12:return e.sent(),g.useHashPKr&&(r.UseHashPKr=!0),!0!==g.again?(r.CurrentBlock=g.lastBlockNumber,latestBlock=g.lastBlockNumber,[3,13]):(r.PkrIndex=r.PkrIndex+1,T=1,utils_1.isNewVersion(utils_1.default.toBuffer(a.TK))&&(T=2),r.PKr=jsuperzk.createPkrHash(a.TK,r.PkrIndex,T),c=r.PkrIndex,[3,10]);case 13:return[4,m.update(tables_1.tables.syncInfo.name,r)];case 14:return e.sent(),[4,_checkNil(a.TK)];case 15:e.sent(),e.label=16;case 16:return n++,[3,2];case 17:return[2]}})})}function _indexUtxos(d,b,h){return __awaiter(this,void 0,void 0,function(){var t,n,s,a,r,u,o,c,i,l,f,_;return __generator(this,function(e){switch(e.label){case 0:if(!(d.utxos&&0<d.utxos.length))return[3,9];t=0,n=d.utxos,e.label=1;case 1:return t<n.length?((s=n[t]).TK=b,a=utils_1.default.hexToCy(s.Asset.Tkn.Currency),[4,h.select(tables_1.tables.assets.name,{Currency:a})]):[3,9];case 2:return r=e.sent(),[4,h.update(tables_1.tables.utxo.name,s)];case 3:return e.sent(),[4,changeAssets(r,s,h,tables_1.TxType.in)];case 4:if(e.sent(),!s.Nils)return[3,8];u=0,o=s.Nils,e.label=5;case 5:return u<o.length?(c=o[u],i={Nil:c,Root:s.Root},[4,h.update(tables_1.tables.nils.name,i)]):[3,8];case 6:e.sent(),e.label=7;case 7:return u++,[3,5];case 8:return t++,[3,1];case 9:if(!(d.txInfos&&0<d.txInfos.length))return[3,13];l=0,f=d.txInfos,e.label=10;case 10:return l<f.length?((_=f[l]).TK=b,_.Num_TxHash=_.Num+"_"+_.TxHash,_deletePending(h,_),[4,h.update(tables_1.tables.tx.name,_)]):[3,13];case 11:e.sent(),e.label=12;case 12:return l++,[3,10];case 13:return[2]}})})}function fetchAndIndex(f,s,_,a,r){return console.log("fetchAndIndex>>>> ",s,_,a,r),new Promise(function(u,t){var l=genPKrs(f,s,_),e=[];if(r&&0<r){var n=[];l.CurrentPKrMap.forEach(function(e,t){n.push(t)}),e=[n,a,r]}else e=[l.PKrs,a,null];jsonRpcReq("light_getOutsByPKr",e).then(function(e){var t=e.data,n={utxos:null,again:!1,useHashPKr:!1,remoteNum:0,nextNum:0,lastBlockNumber:0,txInfos:null},s=!1,a=!1;if(t.result){var r=t.result.BlockOuts,o=[],c=[],i=[];r&&0<r.length&&r.forEach(function(e,t){e.Data.forEach(function(e,t){o.push(e.Out);var n=e.TxInfo,s=jsuperzk.decOut(f,[e.Out]);n.Root=e.Out.Root;var a={TxHash:n.TxHash,TxType:tables_1.TxType.in,Root:e.Out.Root,Asset:s[0].Asset,TxHash_Root_TxType:[n.TxHash,n.Root,tables_1.TxType.in].join("_"),Num_TxHash:[n.Num,n.TxHash].join("_")};if(c.push(n),s[0].Asset&&s[0].Asset.Tkn){var r=utils_1.default.hexToCy(s[0].Asset.Tkn.Currency),u={Num:n.Num,TxHash:n.TxHash,Currency:r,id:[n.Num,n.TxHash,r].join("_")};db.get(f).update(tables_1.tables.txCurrency.name,u).then(function(e){console.log("index txCurrency success")}).catch(function(e){console.log(e)})}db.get(f).update(tables_1.tables.txBase.name,a).then(function(e){console.log("index txInfo success")}).catch(function(e){console.log(e)}),i=i.concat(s)})}),i.forEach(function(e){l.CurrentPKrMap.has(e.Pkr)&&(n.again=!0),_||(l.PKrTypeMap.get(e.Pkr)===PKrType.New?s=!0:l.PKrTypeMap.get(e.Pkr)===PKrType.Old&&(a=!0))}),n.txInfos=c,n.utxos=i,n.lastBlockNumber=t.result.CurrentNum,n.remoteNum=t.result.CurrentNum,_||!s||a||(n.useHashPKr=!0)}u(n)}).catch(function(e){t(e)})})}function jsonRpcReq(s,a){return new Promise(function(t,n){rpc||n(new Error("rpc host not set!"));var e={id:rpcId++,jsonrpc:"2.0",method:s,params:a};return axios_1.default.post(rpc,e).then(function(e){t(e)}).catch(function(e){n(e)})})}function genPKrs(e,t,n){var s=new Array,a=new Map,r=new Map,u=1,o=utils_1.isNewVersion(utils_1.default.toBuffer(e));o&&(u=2);var c=1;5<t&&(c=t-5);for(var i=jsuperzk.createPkrHash(e,1,u),l=t;c<=l;l--){var f=jsuperzk.createPkrHash(e,l,u);a.set(f,PKrType.New),s.push(f),l===t&&r.set(f,!0)}if(-1===s.indexOf(i)&&s.push(i),!o){var _=jsuperzk.createOldPkrHash(e,1,u);if(!n)for(l=t;c<=l;l--){var d=jsuperzk.createOldPkrHash(e,l,u);a.set(d,PKrType.Old),s.push(d),l===t&&r.set(d,!0)}-1===s.indexOf(_)&&s.push(_)}return{PKrTypeMap:a,CurrentPKrMap:r,PKrs:s}}function _checkNil(p){return __awaiter(this,void 0,void 0,function(){function t(x){return __awaiter(this,void 0,void 0,function(){var t,n,s,a,r,u,o,c,i,l,f,_,d,b,h,g,T,m;return __generator(this,function(e){switch(e.label){case 0:return[4,jsonRpcReq("light_checkNil",[x])];case 1:if(!((t=e.sent())&&t.data&&t.data.result))return[3,15];if(!(n=t.data.result))return[3,15];s=0,a=n,e.label=2;case 2:return s<a.length?(r=a[s],u=r.TxInfo,o={Nil:r.Nil},u.TK=p,u.Num_TxHash=u.Num+"_"+u.TxHash,_deletePending(db.get(p),u),[4,db.get(p).select(tables_1.tables.nils.name,o)]):[3,15];case 3:if(!((c=e.sent())&&0<c.length))return[3,12];i=0,l=c,e.label=4;case 4:return i<l.length?(f=l[i],[4,db.get(p).delete(tables_1.tables.nils.name,o)]):[3,12];case 5:return e.sent(),_=f.Root,[4,db.get(p).select(tables_1.tables.utxo.name,{Root:_})];case 6:return(d=e.sent())&&(b=d[0])?(h={TxHash:u.TxHash,TxType:tables_1.TxType.out,Root:_,Asset:b.Asset,TxHash_Root_TxType:[u.TxHash,_,tables_1.TxType.out].join("_"),Num_TxHash:[u.Num,u.TxHash].join("_")},[4,db.get(p).update(tables_1.tables.txBase.name,h)]):[3,11];case 7:return e.sent(),g=utils_1.default.hexToCy(b.Asset.Tkn.Currency),[4,db.get(p).select(tables_1.tables.assets.name,{Currency:g})];case 8:return[4,changeAssets(e.sent(),b,db.get(p),tables_1.TxType.out)];case 9:return e.sent(),[4,db.get(p).delete(tables_1.tables.utxo.name,{Root:_})];case 10:e.sent(),b.Asset&&b.Asset.Tkn&&(T=utils_1.default.hexToCy(b.Asset.Tkn.Currency),m={Num:u.Num,TxHash:u.TxHash,Currency:utils_1.default.hexToCy(b.Asset.Tkn.Currency),id:[u.Num,u.TxHash,T].join("_")},db.get(p).update(tables_1.tables.txCurrency.name,m).then(function(e){console.log("index txCurrency success")}).catch(function(e){console.log(e)})),e.label=11;case 11:return i++,[3,4];case 12:return[4,db.get(p).update(tables_1.tables.tx.name,u)];case 13:e.sent(),e.label=14;case 14:return s++,[3,2];case 15:return[2]}})})}var n,s,a,r,u;return __generator(this,function(e){switch(e.label){case 0:return[4,db.get(p).selectAll(tables_1.tables.nils.name)];case 1:n=e.sent(),s=new Array,a=0,r=n,e.label=2;case 2:return a<r.length?(u=r[a],s.push(u.Nil),100<=s.length?[4,t(s)]:[3,4]):[3,5];case 3:e.sent(),s=new Array,e.label=4;case 4:return a++,[3,2];case 5:return s&&0<s.length?[4,t(s)]:[3,7];case 6:e.sent(),e.label=7;case 7:return[2]}})})}function _setLatestSyncTime(){latestSyncTime=(new Date).getTime()}!function(e){e[e.New=0]="New",e[e.Old=1]="Old"}(PKrType=PKrType||{});